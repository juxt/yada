<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
<head profile="http://dublincore.org/documents/2008/08/04/dc-html/">
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <meta name="robots" content="index,follow" />
    <meta name="creator" content="rfcmarkup version 1.111" />
    <link rel="schema.DC" href="http://purl.org/dc/elements/1.1/" />
<meta name="DC.Relation.Replaces" content="draft-petersson-forwarded-for" />
<meta name="DC.Identifier" content="urn:ietf:rfc:7239" />
<meta name="DC.Date.Issued" content="June, 2014" />
<meta name="DC.Creator" content="Nilsson, Martin" />
<meta name="DC.Creator" content="Petersson, Andreas" />
<meta name="DC.Description.Abstract" content="This document defines an HTTP extension header field that allows proxy
components to disclose information lost in the proxying process, for
example, the originating IP address of a request or IP address of the
proxy on the user-agent-facing interface. In a path of proxying
components, this makes it possible to arrange it so that each
subsequent component will have access to, for example, all IP
addresses used in the chain of proxied HTTP requests.  This document
also specifies guidelines for a proxy administrator to anonymize the
origin of a request." />
<meta name="DC.Title" content="Forwarded HTTP Extension" />

    <link rel="icon" href="/images/rfc.png" type="image/png" />
    <link rel="shortcut icon" href="/images/rfc.png" type="image/png" />
    <title>RFC 7239 - Forwarded HTTP Extension</title>
    
    
    <style type="text/css">
	body {
	    margin: 0px 8px;
            font-size: 1em;
	}
        h1, h2, h3, h4, h5, h6, .h1, .h2, .h3, .h4, .h5, .h6 {
	    font-weight: bold;
            line-height: 0pt;
            display: inline;
            white-space: pre;
            font-family: monospace;
            font-size: 1em;
	    font-weight: bold;
        }
        pre {
            font-size: 1em;
            margin-top: 0px;
            margin-bottom: 0px;
        }
	.pre {
	    white-space: pre;
	    font-family: monospace;
	}
	.header{
	    font-weight: bold;
	}
        .newpage {
            page-break-before: always;
        }
        .invisible {
            text-decoration: none;
            color: white;
        }
        a.selflink {
          color: black;
          text-decoration: none;
        }
        @media print {
            body {
                font-family: monospace;
                font-size: 10.5pt;
            }
            h1, h2, h3, h4, h5, h6 {
                font-size: 1em;
            }
        
            a:link, a:visited {
                color: inherit;
                text-decoration: none;
            }
            .noprint {
                display: none;
            }
        }
	@media screen {
	    .grey, .grey a:link, .grey a:visited {
		color: #777;
	    }
            .docinfo {
                background-color: #EEE;
            }
            .top {
                border-top: 7px solid #EEE;
            }
            .bgwhite  { background-color: white; }
            .bgred    { background-color: #F44; }
            .bggrey   { background-color: #666; }
            .bgbrown  { background-color: #840; }            
            .bgorange { background-color: #FA0; }
            .bgyellow { background-color: #EE0; }
            .bgmagenta{ background-color: #F4F; }
            .bgblue   { background-color: #66F; }
            .bgcyan   { background-color: #4DD; }
            .bggreen  { background-color: #4F4; }

            .legend   { font-size: 90%; }
            .cplate   { font-size: 70%; border: solid grey 1px; }
	}
    </style>
    <!--[if IE]>
    <style>
    body {
       font-size: 13px;
       margin: 10px 10px;
    }
    </style>
    <![endif]-->

    <script type="text/javascript"><!--
    function addHeaderTags() {
	var spans = document.getElementsByTagName("span");
	for (var i=0; i < spans.length; i++) {
	    var elem = spans[i];
	    if (elem) {
		var level = elem.getAttribute("class");
                if (level == "h1" || level == "h2" || level == "h3" || level == "h4" || level == "h5" || level == "h6") {
                    elem.innerHTML = "<"+level+">"+elem.innerHTML+"</"+level+">";		
                }
	    }
	}
    }
    var legend_html = "Colour legend:<br />      <table>         <tr><td>Unknown:</td>                   <td><span class='cplate bgwhite'>&nbsp;&nbsp;&nbsp;&nbsp;</span></td></tr>         <tr><td>Draft:</td>                     <td><span class='cplate bgred'>&nbsp;&nbsp;&nbsp;&nbsp;</span></td></tr>         <tr><td>Informational:</td>             <td><span class='cplate bgorange'>&nbsp;&nbsp;&nbsp;&nbsp;</span></td></tr>         <tr><td>Experimental:</td>              <td><span class='cplate bgyellow'>&nbsp;&nbsp;&nbsp;&nbsp;</span></td></tr>         <tr><td>Best Common Practice:</td>      <td><span class='cplate bgmagenta'>&nbsp;&nbsp;&nbsp;&nbsp;</span></td></tr>         <tr><td>Proposed Standard:</td>         <td><span class='cplate bgblue'>&nbsp;&nbsp;&nbsp;&nbsp;</span></td></tr>         <tr><td>Draft Standard (old designation):</td> <td><span class='cplate bgcyan'>&nbsp;&nbsp;&nbsp;&nbsp;</span></td></tr>         <tr><td>Internet Standard:</td>         <td><span class='cplate bggreen'>&nbsp;&nbsp;&nbsp;&nbsp;</span></td></tr>         <tr><td>Historic:</td>                  <td><span class='cplate bggrey'>&nbsp;&nbsp;&nbsp;&nbsp;</span></td></tr>         <tr><td>Obsolete:</td>                  <td><span class='cplate bgbrown'>&nbsp;&nbsp;&nbsp;&nbsp;</span></td></tr>     </table>";
    function showElem(id) {
        var elem = document.getElementById(id);
        elem.innerHTML = eval(id+"_html");
        elem.style.visibility='visible';
    }
    function hideElem(id) {
        var elem = document.getElementById(id);
        elem.style.visibility='hidden';        
        elem.innerHTML = "";
    }
    // -->
    </script>
</head>
<body onload="addHeaderTags()">
   <div style="height: 13px;">
      <div onmouseover="this.style.cursor='pointer';"
         onclick="showElem('legend');"
         onmouseout="hideElem('legend')"
	 style="height: 6px; position: absolute;"
         class="pre noprint docinfo bgblue"
         title="Click for colour legend." >                                                                        </div>
      <div id="legend"
           class="docinfo noprint pre legend"
           style="position:absolute; top: 4px; left: 4ex; visibility:hidden; background-color: white; padding: 4px 9px 5px 7px; border: solid #345 1px; "
           onmouseover="showElem('legend');"
           onmouseout="hideElem('legend');">
      </div>
   </div>
<span class="pre noprint docinfo top">[<a href="../html/" title="Document search and retrieval page">Docs</a>] [<a href="/rfc/rfc7239.txt" title="Plaintext version of this document">txt</a>|<a href="/pdf/rfc7239" title="PDF version of this document">pdf</a>] [<a href="./draft-ietf-appsawg-http-forwarded" title="draft-ietf-appsawg-http-forwarded">draft-ietf-appsaw...</a>] [<a href="/rfcdiff?difftype=--hwdiff&amp;url2=rfc7239" title="Inline diff (wdiff)">Diff1</a>] [<a href="/rfcdiff?url2=rfc7239" title="Side-by-side diff">Diff2</a>]                 </span><br />
<span class="pre noprint docinfo">                                                                        </span><br />
<span class="pre noprint docinfo">                                                       PROPOSED STANDARD</span><br />
<span class="pre noprint docinfo">                                                                        </span><br />
<pre>
Internet Engineering Task Force (IETF)                      A. Petersson
Request for Comments: 7239                                    M. Nilsson
Category: Standards Track                                 Opera Software
ISSN: 2070-1721                                                June 2014


                        <span class="h1">Forwarded HTTP Extension</span>

Abstract

   This document defines an HTTP extension header field that allows
   proxy components to disclose information lost in the proxying
   process, for example, the originating IP address of a request or IP
   address of the proxy on the user-agent-facing interface.  In a path
   of proxying components, this makes it possible to arrange it so that
   each subsequent component will have access to, for example, all IP
   addresses used in the chain of proxied HTTP requests.

   This document also specifies guidelines for a proxy administrator to
   anonymize the origin of a request.

Status of This Memo

   This is an Internet Standards Track document.

   This document is a product of the Internet Engineering Task Force
   (IETF).  It represents the consensus of the IETF community.  It has
   received public review and has been approved for publication by the
   Internet Engineering Steering Group (IESG).  Further information on
   Internet Standards is available in <a href="./rfc5741#section-2">Section&nbsp;2 of RFC 5741</a>.

   Information about the current status of this document, any errata,
   and how to provide feedback on it may be obtained at
   <a href="http://www.rfc-editor.org/info/rfc7239">http://www.rfc-editor.org/info/rfc7239</a>.

















<span class="grey">Petersson &amp; Nilsson          Standards Track                    [Page 1]</span>
</pre><!--NewPage--><pre class='newpage'><a name="page-2" id="page-2" href="#page-2" class="invisible"> </a>
<span class="grey"><a href="./rfc7239">RFC 7239</a>                Forwarded HTTP Extension               June 2014</span>


Copyright Notice

   Copyright (c) 2014 IETF Trust and the persons identified as the
   document authors.  All rights reserved.

   This document is subject to <a href="./bcp78">BCP 78</a> and the IETF Trust's Legal
   Provisions Relating to IETF Documents
   (<a href="http://trustee.ietf.org/license-info">http://trustee.ietf.org/license-info</a>) in effect on the date of
   publication of this document.  Please review these documents
   carefully, as they describe your rights and restrictions with respect
   to this document.  Code Components extracted from this document must
   include Simplified BSD License text as described in <a href="#section-4">Section 4</a>.e of
   the Trust Legal Provisions and are provided without warranty as
   described in the Simplified BSD License.

Table of Contents

   <a href="#section-1">1</a>. Introduction ....................................................<a href="#page-3">3</a>
   <a href="#section-2">2</a>. Notational Conventions ..........................................<a href="#page-4">4</a>
   <a href="#section-3">3</a>. Syntax Notations ................................................<a href="#page-4">4</a>
   <a href="#section-4">4</a>. Forwarded HTTP Header Field .....................................<a href="#page-4">4</a>
   <a href="#section-5">5</a>. Parameters ......................................................<a href="#page-6">6</a>
      <a href="#section-5.1">5.1</a>. Forwarded By ...............................................<a href="#page-6">6</a>
      <a href="#section-5.2">5.2</a>. Forwarded For ..............................................<a href="#page-6">6</a>
      <a href="#section-5.3">5.3</a>. Forwarded Host .............................................<a href="#page-7">7</a>
      <a href="#section-5.4">5.4</a>. Forwarded Proto ............................................<a href="#page-7">7</a>
      <a href="#section-5.5">5.5</a>. Extensions .................................................<a href="#page-7">7</a>
   <a href="#section-6">6</a>. Node Identifiers ................................................<a href="#page-8">8</a>
      <a href="#section-6.1">6.1</a>. IPv4 and IPv6 Identifiers ..................................<a href="#page-9">9</a>
      <a href="#section-6.2">6.2</a>. The "unknown" Identifier ...................................<a href="#page-9">9</a>
      <a href="#section-6.3">6.3</a>. Obfuscated Identifier ......................................<a href="#page-9">9</a>
   <a href="#section-7">7</a>. Implementation Considerations ..................................<a href="#page-10">10</a>
      <a href="#section-7.1">7.1</a>. HTTP Lists ................................................<a href="#page-10">10</a>
      <a href="#section-7.2">7.2</a>. Header Field Preservation .................................<a href="#page-10">10</a>
      <a href="#section-7.3">7.3</a>. Relation to Via ...........................................<a href="#page-10">10</a>
      <a href="#section-7.4">7.4</a>. Transition ................................................<a href="#page-11">11</a>
      <a href="#section-7.5">7.5</a>. Example Usage .............................................<a href="#page-11">11</a>
   <a href="#section-8">8</a>. Security Considerations ........................................<a href="#page-12">12</a>
      <a href="#section-8.1">8.1</a>. Header Validity and Integrity .............................<a href="#page-12">12</a>
      <a href="#section-8.2">8.2</a>. Information Leak ..........................................<a href="#page-12">12</a>
      <a href="#section-8.3">8.3</a>. Privacy Considerations ....................................<a href="#page-12">12</a>
   <a href="#section-9">9</a>. IANA Considerations ............................................<a href="#page-14">14</a>
   <a href="#section-10">10</a>. References ....................................................<a href="#page-14">14</a>
      <a href="#section-10.1">10.1</a>. Normative References .....................................<a href="#page-14">14</a>
      <a href="#section-10.2">10.2</a>. Informative References ...................................<a href="#page-15">15</a>
   <a href="#appendix-A">Appendix A</a>. Acknowledgments .......................................<a href="#page-16">16</a>





<span class="grey">Petersson &amp; Nilsson          Standards Track                    [Page 2]</span>
</pre><!--NewPage--><pre class='newpage'><a name="page-3" id="page-3" href="#page-3" class="invisible"> </a>
<span class="grey"><a href="./rfc7239">RFC 7239</a>                Forwarded HTTP Extension               June 2014</span>


<span class="h2"><a class="selflink" name="section-1" href="#section-1">1</a>.  Introduction</span>

   In today's HTTP landscape, there are a multitude of different
   applications that act as proxies for the user agents.  In many cases,
   these proxies exists without the action or knowledge of the end-user.
   These cases occur, for example, when the proxy exists as a part of
   the infrastructure within the organization running the web server.
   Such proxies may be used for features such as load balancing or
   crypto offload.  Another example is when the proxy is used within the
   same organization as the user, and the proxy is used to cache
   resources.  However, these proxies make the requests appear as if
   they originated from the proxy's IP address, and they may change
   other information in the original request.  This represents a loss of
   information from the original request.

   This loss of information can cause problems for a web server that has
   a specific use for the clients' IP addresses that will not be met by
   using the address of the proxy or other information changed by the
   proxy.  The main uses of this information are for diagnostics, access
   control, and abuse management.  Diagnostic functions can include
   event logging, troubleshooting, and statistics gathering, and the
   information collected is usually only stored for short periods of
   time and only gathered in response to a particular problem or a
   complaint from the client.  Access control can be operated by
   configuring a list of client IP addresses from which access is
   permitted, but this approach will not work if a proxy is used, unless
   the proxy is trusted and is, itself, configured with a list of
   allowed client addresses for the server.  Cases of abuse require
   identification of the abuser and this uses many of the same features
   identified for diagnostics.

   Most of the time that a proxy is used, this loss of information is
   not the primary purpose, or even a desired effect, of using the
   proxy.  Thus, to restore the desired functionality when a proxy is in
   use, a way of disclosing the original information at the HTTP level
   is needed.  Clearly, however, when the purpose of using a proxy is to
   provide client anonymity, the proxy will not use the feature defined
   in this document.

   It should be noted that the use of a reverse proxy also hides
   information.  Again, where the loss of information is not a
   deliberate function of the use of the reverse proxy, it can be
   desirable to find a way to encode the information within the HTTP
   messages so that the consumer can see it.

   A common way to disclose this information is by using the non-
   standard header fields such as X-Forwarded-For, X-Forwarded-By, and
   X-Forwarded-Proto.  There are many benefits to using a standardized



<span class="grey">Petersson &amp; Nilsson          Standards Track                    [Page 3]</span>
</pre><!--NewPage--><pre class='newpage'><a name="page-4" id="page-4" href="#page-4" class="invisible"> </a>
<span class="grey"><a href="./rfc7239">RFC 7239</a>                Forwarded HTTP Extension               June 2014</span>


   approach to commonly desired protocol function: not least is
   interoperability between implementations.  This document standardizes
   a header field called "Forwarded" and provides the syntax and
   semantics for disclosing such information.  "Forwarded" also combines
   all the information within one single header field, making it
   possible to correlate that information.  With the header field format
   described in this document, it is possible to know what information
   belongs together, as long as the proxies are trusted.  Such
   conclusions are not possible to make with the X-Forwarded class of
   header fields.  The header field defined in this document is optional
   such that implementations of proxies that are intended to provide
   privacy are not required to operate or implement the header field.

   Note that similar issues to those described for proxies also arise
   with use of NATs.  This is discussed further in [<a href="./rfc6269" title="&quot;Issues with IP Address Sharing&quot;">RFC6269</a>].

<span class="h2"><a class="selflink" name="section-2" href="#section-2">2</a>.  Notational Conventions</span>

   The key words "MUST", "MUST NOT", "REQUIRED", "SHALL", "SHALL NOT",
   "SHOULD", "SHOULD NOT", "RECOMMENDED", "MAY", and "OPTIONAL" in this
   document are to be interpreted as described in [<a href="./rfc2119" title="&quot;Key words for use in RFCs to Indicate Requirement Levels&quot;">RFC2119</a>].

<span class="h2"><a class="selflink" name="section-3" href="#section-3">3</a>.  Syntax Notations</span>

   This specification uses the Augmented Backus-Naur Form (ABNF)
   notation of [<a href="./rfc5234" title="&quot;Augmented BNF for Syntax Specifications: ABNF&quot;">RFC5234</a>] with the list rule extension defined in <a href="#section-7">Section</a>
   <a href="#section-7">7</a> of [<a href="./rfc7230" title="&quot;Hypertext Transfer Protocol (HTTP/1.1): Message Syntax and Routing&quot;">RFC7230</a>].

<span class="h2"><a class="selflink" name="section-4" href="#section-4">4</a>.  Forwarded HTTP Header Field</span>

   The "Forwarded" HTTP header field is an OPTIONAL header field that,
   when used, contains a list of parameter-identifier pairs that
   disclose information that is altered or lost when a proxy is involved
   in the path of the request.  Due to the sensitive nature of the data
   passed in this header field (see Sections <a href="#section-8.2">8.2</a> and <a href="#section-8.3">8.3</a>), this header
   field should be turned off by default.  Further, each parameter
   should be configured individually.  "Forwarded" is only for use in
   HTTP requests and is not to be used in HTTP responses.  This applies
   to forwarding proxies, as well as reverse proxies.  Information
   passed in this header field can be, for example, the source IP
   address of the request, the IP address of the incoming interface on
   the proxy, or whether HTTP or HTTPS was used.  If the request is
   passing through several proxies, each proxy can add a set of
   parameters; it can also remove previously added "Forwarded" header
   fields.






<span class="grey">Petersson &amp; Nilsson          Standards Track                    [Page 4]</span>
</pre><!--NewPage--><pre class='newpage'><a name="page-5" id="page-5" href="#page-5" class="invisible"> </a>
<span class="grey"><a href="./rfc7239">RFC 7239</a>                Forwarded HTTP Extension               June 2014</span>


   The top-level list is represented as a list of HTTP header
   field-values as defined in <a href="./rfc7230#section-3.2">Section&nbsp;3.2 of [RFC7230]</a>.  The first
   element in this list holds information added by the first proxy that
   implements and uses this header field, and each subsequent element
   holds information added by each subsequent proxy.  Because this
   header field is optional, any proxy in the chain may choose not to
   update this header field.  Each field-value is a semicolon-separated
   list; this sublist consists of parameter-identifier pairs.
   Parameter-identifier pairs are grouped together by an equals sign.
   Each parameter MUST NOT occur more than once per field-value.  The
   parameter names are case-insensitive.  The header field value can be
   defined in ABNF syntax as:

       Forwarded   = 1#forwarded-element

       forwarded-element =
           [ forwarded-pair ] *( ";" [ forwarded-pair ] )

       forwarded-pair = token "=" value
       value          = token / quoted-string

       token = &lt;Defined in <a href="./rfc7230#section-3.2.6">[RFC7230], Section&nbsp;3.2.6</a>&gt;
       quoted-string = &lt;Defined in <a href="./rfc7230#section-3.2.6">[RFC7230], Section&nbsp;3.2.6</a>&gt;

   Examples:

       Forwarded: for="_gazonk"
       Forwarded: For="[2001:db8:cafe::17]:4711"
       Forwarded: for=192.0.2.60;proto=http;by=203.0.113.43
       Forwarded: for=192.0.2.43, for=198.51.100.17

   Note that as ":" and "[]" are not valid characters in "token", IPv6
   addresses are written as "quoted-string".

   A proxy server that wants to add a new "Forwarded" header field value
   can either append it to the last existing "Forwarded" header field
   after a comma separator or add a new field at the end of the header
   block.  A proxy MAY remove all "Forwarded" header fields from a
   request.  It MUST, however, ensure that the correct header field is
   updated in case of multiple "Forwarded" header fields.











<span class="grey">Petersson &amp; Nilsson          Standards Track                    [Page 5]</span>
</pre><!--NewPage--><pre class='newpage'><a name="page-6" id="page-6" href="#page-6" class="invisible"> </a>
<span class="grey"><a href="./rfc7239">RFC 7239</a>                Forwarded HTTP Extension               June 2014</span>


<span class="h2"><a class="selflink" name="section-5" href="#section-5">5</a>.  Parameters</span>

   This document specifies a number of parameters and valid values for
   each of them:

   o  "by" identifies the user-agent facing interface of the proxy.

   o  "for" identifies the node making the request to the proxy.

   o  "host" is the host request header field as received by the proxy.

   o  "proto" indicates what protocol was used to make the request.

<span class="h3"><a class="selflink" name="section-5.1" href="#section-5.1">5.1</a>.  Forwarded By</span>

   The "by" parameter is used to disclose the interface where the
   request came in to the proxy server.  When proxies choose to use the
   "by" parameter, its default configuration SHOULD contain an
   obfuscated identifier as described in <a href="#section-6.3">Section 6.3</a>.  If the server
   receiving proxied requests requires some address-based functionality,
   this parameter MAY instead contain an IP address (and, potentially, a
   port number).  A third option is the "unknown" identifier described
   in <a href="#section-6.2">Section 6.2</a>.

   The syntax of a "by" value, after potential quoted-string unescaping,
   conforms to the "node" ABNF described in <a href="#section-6">Section 6</a>.

   This is primarily added by reverse proxies that wish to forward this
   information to the backend server.  It can also be interesting in a
   multihomed environment to signal to backend servers from which the
   request came.

<span class="h3"><a class="selflink" name="section-5.2" href="#section-5.2">5.2</a>.  Forwarded For</span>

   The "for" parameter is used to disclose information about the client
   that initiated the request and subsequent proxies in a chain of
   proxies.  When proxies choose to use the "for" parameter, its default
   configuration SHOULD contain an obfuscated identifier as described in
   <a href="#section-6.3">Section 6.3</a>.  If the server receiving proxied requests requires some
   address-based functionality, this parameter MAY instead contain an IP
   address (and, potentially, a port number).  A third option is the
   "unknown" identifier described in <a href="#section-6.2">Section 6.2</a>.

   The syntax of a "for" value, after potential quoted-string
   unescaping, conforms to the "node" ABNF described in <a href="#section-6">Section 6</a>.






<span class="grey">Petersson &amp; Nilsson          Standards Track                    [Page 6]</span>
</pre><!--NewPage--><pre class='newpage'><a name="page-7" id="page-7" href="#page-7" class="invisible"> </a>
<span class="grey"><a href="./rfc7239">RFC 7239</a>                Forwarded HTTP Extension               June 2014</span>


   In a chain of proxy servers where this is fully utilized, the first
   "for" parameter will disclose the client where the request was first
   made, followed by any subsequent proxy identifiers.  The last proxy
   in the chain is not part of the list of "for" parameters.  The last
   proxy's IP address, and optionally a port number, are, however,
   readily available as the remote IP address at the transport layer.
   It can, however, be more relevant to read information about the last
   proxy from preceding "Forwarded" header field's "by" parameter, if
   present.

<span class="h3"><a class="selflink" name="section-5.3" href="#section-5.3">5.3</a>.  Forwarded Host</span>

   The "host" parameter is used to forward the original value of the
   "Host" header field.  This can be used, for example, by the origin
   server if a reverse proxy is rewriting the "Host" header field to
   some internal host name.

   The syntax for a "host" value, after potential quoted-string
   unescaping, MUST conform to the Host ABNF described in <a href="./rfc7230#section-5.4">Section&nbsp;5.4 of
   [RFC7230]</a>.

<span class="h3"><a class="selflink" name="section-5.4" href="#section-5.4">5.4</a>.  Forwarded Proto</span>

   The "proto" parameter has the value of the used protocol type.  The
   syntax of a "proto" value, after potential quoted-string unescaping,
   MUST conform to the URI scheme name as defined in <a href="./rfc3986#section-3.1">Section&nbsp;3.1 in
   [RFC3986]</a> and registered with IANA according to [<a href="./rfc4395" title="&quot;Guidelines and Registration Procedures for New URI Schemes&quot;">RFC4395</a>].  Typical
   values are "http" or "https".

   For example, in an environment where a reverse proxy is also used as
   a crypto offloader, this allows the origin server to rewrite URLs in
   a document to match the type of connection as the user agent
   requested, even though all connections to the origin server are
   unencrypted HTTP.

<span class="h3"><a class="selflink" name="section-5.5" href="#section-5.5">5.5</a>.  Extensions</span>

   Extensions allow for additional parameters and values.  Extensions
   can be particularly useful in reverse proxy environments.  All
   extension parameters SHOULD be registered in the "HTTP Forwarded
   Parameter" registry.  If certain extensions are expected to have
   widespread deployment, they SHOULD also be standardized.  This is
   further discussed in <a href="#section-9">Section 9</a>.








<span class="grey">Petersson &amp; Nilsson          Standards Track                    [Page 7]</span>
</pre><!--NewPage--><pre class='newpage'><a name="page-8" id="page-8" href="#page-8" class="invisible"> </a>
<span class="grey"><a href="./rfc7239">RFC 7239</a>                Forwarded HTTP Extension               June 2014</span>


<span class="h2"><a class="selflink" name="section-6" href="#section-6">6</a>.  Node Identifiers</span>

   The node identifier is one of the following:

   o  The client's IP address, with an optional port number

   o  A token indicating that the IP address of the client is not known
      to the proxy server

   o  A generated token, allowing for tracing and debugging, while
      allowing the internal structure or sensitive information to be
      hidden

   The node identifier is defined by the ABNF syntax as:

       node     = nodename [ ":" node-port ]
       nodename = IPv4address / "[" IPv6address "]" /
                   "unknown" / obfnode

       IPv4address = &lt;Defined in <a href="./rfc3986#section-3.2.2">[RFC3986], Section&nbsp;3.2.2</a>&gt;
       IPv6address = &lt;Defined in <a href="./rfc3986#section-3.2.2">[RFC3986], Section&nbsp;3.2.2</a>&gt;
       obfnode = "_" 1*( ALPHA / DIGIT / "." / "_" / "-")

       node-port     = port / obfport
       port          = 1*5DIGIT
       obfport       = "_" 1*(ALPHA / DIGIT / "." / "_" / "-")

       DIGIT = &lt;Defined in <a href="./rfc5234#section-3.4">[RFC5234], Section&nbsp;3.4</a>&gt;
       ALPHA = &lt;Defined in [<a href="./rfc5234" title="&quot;Augmented BNF for Syntax Specifications: ABNF&quot;">RFC5234</a>], Section B.1&gt;

   Each of the identifiers may optionally have the port identifier, for
   example, allowing the identification of the endpoint in a NATed
   environment.  The "node-port" can be identified either by its port
   number or by a generated token obfuscating the real port number.  An
   obfuscated port may be used in situations where the possessor of the
   proxy wants the ability to trace requests -- for example, in debug
   purposes -- but does not want to reveal internal information.

   Note that the ABNF above also allows port numbers to be appended to
   the "unknown" identifier.  Interpretation of such notation is,
   however, left to the possessor of a proxy adding such a value to the
   header field.  To distinguish an "obfport" from a port, the "obfport"
   MUST have a leading underscore.  Further, it MUST also consist of
   only "ALPHA", "DIGIT", and the characters ".", "_", and "-".

   It is important to note that an IPv6 address and any nodename with
   node-port specified MUST be quoted, since ":" is not an allowed
   character in "token".



<span class="grey">Petersson &amp; Nilsson          Standards Track                    [Page 8]</span>
</pre><!--NewPage--><pre class='newpage'><a name="page-9" id="page-9" href="#page-9" class="invisible"> </a>
<span class="grey"><a href="./rfc7239">RFC 7239</a>                Forwarded HTTP Extension               June 2014</span>


   Examples:

             "192.0.2.43:47011"
             "[2001:db8:cafe::17]:47011"

<span class="h3"><a class="selflink" name="section-6.1" href="#section-6.1">6.1</a>.  IPv4 and IPv6 Identifiers</span>

   The ABNF rules for "IPv6address" and "IPv4address" are defined in
   [<a href="./rfc3986" title="&quot;Uniform Resource Identifier (URI): Generic Syntax&quot;">RFC3986</a>].  The "IPv6address" SHOULD comply with textual
   representation recommendations [<a href="./rfc5952" title="&quot;A Recommendation for IPv6 Address Text Representation&quot;">RFC5952</a>] (for example, lowercase,
   compression of zeros).

   Note that the IP address may be one from the internal nets, as
   defined in [<a href="./rfc1918" title="&quot;Address Allocation for Private Internets&quot;">RFC1918</a>] and [<a href="./rfc4193" title="&quot;Unique Local IPv6 Unicast Addresses&quot;">RFC4193</a>].  Also, note that an IPv6 address
   is always enclosed in square brackets.

<span class="h3"><a class="selflink" name="section-6.2" href="#section-6.2">6.2</a>.  The "unknown" Identifier</span>

   The "unknown" identifier is used when the identity of the preceding
   entity is not known, but the proxy server still wants to signal that
   a forwarding of the request was made.  One example would be a proxy
   server process generating an outgoing request without direct access
   to the incoming request TCP socket.

<span class="h3"><a class="selflink" name="section-6.3" href="#section-6.3">6.3</a>.  Obfuscated Identifier</span>

   A generated identifier may be used where there is a wish to keep the
   internal IP addresses secret, while still allowing the "Forwarded"
   header field to be used for tracing and debugging.  This can also be
   useful if the proxy uses some sort of interface labels and there is a
   desire to pass them rather than an IP address.  Unless static
   assignment of identifiers is necessary for the server's use of the
   identifiers, obfuscated identifiers SHOULD be randomly generated for
   each request.  If the server requires that identifiers persist across
   requests, they SHOULD NOT persist longer than client IP addresses.
   To distinguish the obfuscated identifier from other identifiers, it
   MUST have a leading underscore "_".  Furthermore, it MUST also
   consist of only "ALPHA", "DIGIT", and the characters ".", "_", and
   "-".
   Example:

       Forwarded: for=_hidden, for=_SEVKISEK









<span class="grey">Petersson &amp; Nilsson          Standards Track                    [Page 9]</span>
</pre><!--NewPage--><pre class='newpage'><a name="page-10" id="page-10" href="#page-10" class="invisible"> </a>
<span class="grey"><a href="./rfc7239">RFC 7239</a>                Forwarded HTTP Extension               June 2014</span>


<span class="h2"><a class="selflink" name="section-7" href="#section-7">7</a>.  Implementation Considerations</span>

<span class="h3"><a class="selflink" name="section-7.1" href="#section-7.1">7.1</a>.  HTTP Lists</span>

   Note that an HTTP list allows white spaces to occur between the
   identifiers, and the list may be split over multiple header fields.
   As an example, the header field

       Forwarded: for=192.0.2.43,for="[2001:db8:cafe::17]",for=unknown

   is equivalent to the header field

       Forwarded: for=192.0.2.43, for="[2001:db8:cafe::17]", for=unknown

   which is equivalent to the header fields

       Forwarded: for=192.0.2.43
       Forwarded: for="[2001:db8:cafe::17]", for=unknown

<span class="h3"><a class="selflink" name="section-7.2" href="#section-7.2">7.2</a>.  Header Field Preservation</span>

   There are some cases when this header field should be kept and some
   cases where it should not be kept.  A directly forwarded request
   should preserve and possibly extend it.  If a single incoming request
   causes the proxy to make multiple outbound requests, special care
   must be taken to decide whether or not the header field should be
   preserved.  In many cases, the header field should be preserved, but
   if the outbound request is not a direct consequence of the incoming
   request, the header field should not be preserved.  Consider also the
   case when a proxy has detected a content mismatch in a 304 response
   and is following the instructions in <a href="./rfc7232#section-4.1">[RFC7232], Section&nbsp;4.1</a> to repeat
   the request unconditionally, in which case the new request is still
   basically a direct consequence of the origin request, and the header
   field should probably be kept.

<span class="h3"><a class="selflink" name="section-7.3" href="#section-7.3">7.3</a>.  Relation to Via</span>

   The "Via" header field (see <a href="./rfc7230#section-5.7.1">[RFC7230], Section&nbsp;5.7.1</a>) is a header
   field with a similar use case as this header field.  The "Via" header
   field, however, only provides information about the proxy itself, and
   thereby leaves out the information about the client connecting to the
   proxy server.  The "Forwarded" header field, on the other hand, has
   relaying information from the client-facing side of the proxy server
   as its main purpose.  As "Via" is already widely deployed, its format
   cannot be changed to address the problems that "Forwarded" addresses.






<span class="grey">Petersson &amp; Nilsson          Standards Track                   [Page 10]</span>
</pre><!--NewPage--><pre class='newpage'><a name="page-11" id="page-11" href="#page-11" class="invisible"> </a>
<span class="grey"><a href="./rfc7239">RFC 7239</a>                Forwarded HTTP Extension               June 2014</span>


   Note that it is not possible to combine information from this header
   field with the information from the Via header field.  Some proxies
   will not update the "Forwarded" header field, some proxies will not
   update the Via header field, and some proxies will update both.

<span class="h3"><a class="selflink" name="section-7.4" href="#section-7.4">7.4</a>.  Transition</span>

   If a proxy gets incoming requests with X-Forwarded-* header fields
   present, it is encouraged to convert these into the header field
   described in this document, if it can be done in a sensible way.  If
   the request only contains one type -- for example, X-Forwarded-For --
   this can be translated to "Forwarded", by prepending each element
   with "for=".  Note that IPv6 addresses may not be quoted in
   X-Forwarded-For and may not be enclosed by square brackets, but they
   are quoted and enclosed in square brackets in "Forwarded".

       X-Forwarded-For: 192.0.2.43, 2001:db8:cafe::17

   becomes:

       Forwarded: for=192.0.2.43, for="[2001:db8:cafe::17]"

   However, special care must be taken if, for example, both
   X-Forwarded-For and X-Forwarded-By exist.  In such cases, it may not
   be possible to do a conversion, since it is not possible to know in
   which order the already existing fields were added.  Also, note that
   removing the X-Forwarded-For header field may cause issues for
   parties that have not yet implemented support for this new header
   field.

<span class="h3"><a class="selflink" name="section-7.5" href="#section-7.5">7.5</a>.  Example Usage</span>

   A request from a client with IP address 192.0.2.43 passes through a
   proxy with IP address 198.51.100.17, then through another proxy with
   IP address 203.0.113.60 before reaching an origin server.  This
   could, for example, be an office client behind a corporate malware
   filter talking to a origin server through a reverse proxy.

   o  The HTTP request between the client and the first proxy has no
      "Forwarded" header field.

   o  The HTTP request between the first and second proxy has a
      "Forwarded: for=192.0.2.43" header field.

   o  The HTTP request between the second proxy and the origin server
      has a "Forwarded: for=192.0.2.43,
      for=198.51.100.17;by=203.0.113.60;proto=http;host=example.com"
      header field.



<span class="grey">Petersson &amp; Nilsson          Standards Track                   [Page 11]</span>
</pre><!--NewPage--><pre class='newpage'><a name="page-12" id="page-12" href="#page-12" class="invisible"> </a>
<span class="grey"><a href="./rfc7239">RFC 7239</a>                Forwarded HTTP Extension               June 2014</span>


   Note that, at some points in a connection chain, the information
   might not be updated in the "Forwarded" header field, either because
   of lack of support of this HTTP extension or because of a policy
   decision not to disclose information about this network component.

<span class="h2"><a class="selflink" name="section-8" href="#section-8">8</a>.  Security Considerations</span>

<span class="h3"><a class="selflink" name="section-8.1" href="#section-8.1">8.1</a>.  Header Validity and Integrity</span>

   The "Forwarded" HTTP header field cannot be relied upon to be
   correct, as it may be modified, whether mistakenly or for malicious
   reasons, by every node on the way to the server, including the client
   making the request.

   One approach to ensure that the "Forwarded" HTTP header field is
   correct is to verify the correctness of proxies and to whitelist them
   as trusted.  This approach has at least two weaknesses.  First, the
   chain of IP addresses listed before the request came to the proxy
   cannot be trusted.  Second, unless the communication between proxies
   and the endpoint is secured, the data can be modified by an attacker
   with access to the network.

<span class="h3"><a class="selflink" name="section-8.2" href="#section-8.2">8.2</a>.  Information Leak</span>

   The "Forwarded" HTTP header field can reveal internal structures of
   the network setup behind the NAT or proxy setup, which may be
   undesired.  This can be addressed either by using obfuscated
   elements, by preventing the internal nodes from updating the HTTP
   header field, or by having an egress proxy remove entries that reveal
   internal network information.

   This header field should never be copied into response messages by
   origin servers or intermediaries, as it can reveal the whole proxy
   chain to the client.  As a side effect, special care must be taken in
   hosting environments not to allow the TRACE request where the
   "Forwarded" field is used, as it would appear in the body of the
   response message.

<span class="h3"><a class="selflink" name="section-8.3" href="#section-8.3">8.3</a>.  Privacy Considerations</span>

   In recent years, there have been growing concerns about privacy.
   There is a trade-off between ensuring privacy for users versus
   disclosing information that is useful, for example, for debugging,
   statistics, and generating location-dependent content.  The
   "Forwarded" HTTP header field, by design, exposes information that
   some users consider privacy sensitive, in order to allow for such
   uses.  For any proxy, if the HTTP request contains header fields that




<span class="grey">Petersson &amp; Nilsson          Standards Track                   [Page 12]</span>
</pre><!--NewPage--><pre class='newpage'><a name="page-13" id="page-13" href="#page-13" class="invisible"> </a>
<span class="grey"><a href="./rfc7239">RFC 7239</a>                Forwarded HTTP Extension               June 2014</span>


   specifically request privacy semantics, the proxy SHOULD NOT use the
   "Forwarded" header field, nor in any other manner pass private
   information, such as IP addresses, on to the next hop.

   The client's IP address, that may be forwarded in the "for" parameter
   of this header field, is considered to be privacy sensitive by many
   people, as the IP address may be able to uniquely identify a client,
   what operator the user is using, and possibly a rough estimation of
   where the user is geographically located.

   Proxies using this extension will preserve the information of a
   direct connection.  This has an end-user privacy impact regardless of
   whether the end-user or deployer knows or expects that this is the
   case.

   Implementers and deployers of such proxies need to consider whether,
   and how, deploying this extension affects user privacy.

   The default configuration for both the "by" and "for" parameters
   SHOULD contain obfuscated identifiers.  These identifiers SHOULD be
   randomly generated per request.  If identifiers that persist across
   requests are required, their lifetimes SHOULD be limited and they
   SHOULD NOT persist longer than client IP addresses.  When generating
   obfuscated identifiers, care must be taken not to include potentially
   sensitive information in them.

   Note that users' IP addresses may already be forwarded by proxies
   using the header field X-Forwarded-For, which is widely used.  It
   should also be noted that if the user were doing the connection
   directly without passing the proxy, the client's IP address would be
   sent to the web server.  Users that do not actively choose an
   anonymizing proxy cannot rely on having their IP address shielded.
   These users who want to minimize the risk of being tracked must also
   note that there are other ways information may leak, for example, by
   browser header field fingerprinting.  The Forwarded header field
   itself, even when used without a uniquely identifying client
   identifier, may make fingerprinting more feasible by revealing the
   chain of proxies traversed by the client's request.













<span class="grey">Petersson &amp; Nilsson          Standards Track                   [Page 13]</span>
</pre><!--NewPage--><pre class='newpage'><a name="page-14" id="page-14" href="#page-14" class="invisible"> </a>
<span class="grey"><a href="./rfc7239">RFC 7239</a>                Forwarded HTTP Extension               June 2014</span>


<span class="h2"><a class="selflink" name="section-9" href="#section-9">9</a>.  IANA Considerations</span>

   This document specifies the HTTP header field listed below, which has
   been added to the "Permanent Message Header Field Names" registry
   defined in [<a href="./rfc3864" title="&quot;Registration Procedures for Message Header Fields&quot;">RFC3864</a>].

   Header field: Forwarded
   Applicable protocol: http
   Status: standard
   Author/Change controller:
       IETF (iesg@ietf.org)
       Internet Engineering Task Force
   Specification document(s): this specification (<a href="#section-4">Section 4</a>)
   Related information: None

   The "Forwarded" header field contains parameters for which IANA has
   created and now maintains a new registry entitled "HTTP Forwarded
   Parameters".  Initial registrations are given below.  For future
   assignments, the registration procedure is IETF Review [<a href="./rfc5226" title="&quot;Guidelines for Writing an IANA Considerations Section in RFCs&quot;">RFC5226</a>].
   The security and privacy implications of all new parameters should be
   thoroughly documented.  New parameters and their values MUST conform
   with the forwarded-pair as defined in ABNF in <a href="#section-4">Section 4</a>.  Further, a
   short description should be provided in the registration.

   +-------------+---------------------------------------+-------------+
   | Parameter   | Description                           | Reference   |
   | name        |                                       |             |
   +-------------+---------------------------------------+-------------+
   | by          | IP address of incoming interface of a | <a href="#section-5.1">Section 5.1</a> |
   |             | proxy                                 |             |
   | for         | IP address of client making a request | <a href="#section-5.2">Section 5.2</a> |
   |             | through a proxy                       |             |
   | host        | Host header field of the incoming     | <a href="#section-5.3">Section 5.3</a> |
   |             | request                               |             |
   | proto       | Application protocol used for         | <a href="#section-5.4">Section 5.4</a> |
   |             | incoming request                      |             |
   +-------------+---------------------------------------+-------------+

                       Table 1: Initial Assignments

<span class="h2"><a class="selflink" name="section-10" href="#section-10">10</a>.  References</span>

<span class="h3"><a class="selflink" name="section-10.1" href="#section-10.1">10.1</a>.  Normative References</span>

   [<a name="ref-RFC1918" id="ref-RFC1918">RFC1918</a>]  Rekhter, Y., Moskowitz, R., Karrenberg, D., Groot, G., and
              E. Lear, "Address Allocation for Private Internets",
              <a href="./bcp5">BCP 5</a>, <a href="./rfc1918">RFC 1918</a>, February 1996.




<span class="grey">Petersson &amp; Nilsson          Standards Track                   [Page 14]</span>
</pre><!--NewPage--><pre class='newpage'><a name="page-15" id="page-15" href="#page-15" class="invisible"> </a>
<span class="grey"><a href="./rfc7239">RFC 7239</a>                Forwarded HTTP Extension               June 2014</span>


   [<a name="ref-RFC2119" id="ref-RFC2119">RFC2119</a>]  Bradner, S., "Key words for use in RFCs to Indicate
              Requirement Levels", <a href="./bcp14">BCP 14</a>, <a href="./rfc2119">RFC 2119</a>, March 1997.

   [<a name="ref-RFC3864" id="ref-RFC3864">RFC3864</a>]  Klyne, G., Nottingham, M., and J. Mogul, "Registration
              Procedures for Message Header Fields", <a href="./bcp90">BCP 90</a>, <a href="./rfc3864">RFC 3864</a>,
              September 2004.

   [<a name="ref-RFC3986" id="ref-RFC3986">RFC3986</a>]  Berners-Lee, T., Fielding, R., and L. Masinter, "Uniform
              Resource Identifier (URI): Generic Syntax", STD 66,
              <a href="./rfc3986">RFC 3986</a>, January 2005.

   [<a name="ref-RFC4193" id="ref-RFC4193">RFC4193</a>]  Hinden, R. and B. Haberman, "Unique Local IPv6 Unicast
              Addresses", <a href="./rfc4193">RFC 4193</a>, October 2005.

   [<a name="ref-RFC4395" id="ref-RFC4395">RFC4395</a>]  Hansen, T., Hardie, T., and L. Masinter, "Guidelines and
              Registration Procedures for New URI Schemes", <a href="./bcp35">BCP 35</a>,
              <a href="./rfc4395">RFC 4395</a>, February 2006.

   [<a name="ref-RFC5226" id="ref-RFC5226">RFC5226</a>]  Narten, T. and H. Alvestrand, "Guidelines for Writing an
              IANA Considerations Section in RFCs", <a href="./bcp26">BCP 26</a>, <a href="./rfc5226">RFC 5226</a>,
              May 2008.

   [<a name="ref-RFC5234" id="ref-RFC5234">RFC5234</a>]  Crocker, D. and P. Overell, "Augmented BNF for Syntax
              Specifications: ABNF", STD 68, <a href="./rfc5234">RFC 5234</a>, January 2008.

   [<a name="ref-RFC5952" id="ref-RFC5952">RFC5952</a>]  Kawamura, S. and M. Kawashima, "A Recommendation for IPv6
              Address Text Representation", <a href="./rfc5952">RFC 5952</a>, August 2010.

   [<a name="ref-RFC7230" id="ref-RFC7230">RFC7230</a>]  Fielding, R., Ed. and J. Reschke, Ed., "Hypertext Transfer
              Protocol (HTTP/1.1): Message Syntax and Routing",
              <a href="./rfc7230">RFC 7230</a>, June 2014.

   [<a name="ref-RFC7232" id="ref-RFC7232">RFC7232</a>]  Fielding, R., Ed. and J. Reschke, Ed., "Hypertext Transfer
              Protocol (HTTP/1.1): Conditional Requests", <a href="./rfc7232">RFC 7232</a>,
              June 2014.

<span class="h3"><a class="selflink" name="section-10.2" href="#section-10.2">10.2</a>.  Informative References</span>

   [<a name="ref-RFC6269" id="ref-RFC6269">RFC6269</a>]  Ford, M., Boucadair, M., Durand, A., Levis, P., and P.
              Roberts, "Issues with IP Address Sharing", <a href="./rfc6269">RFC 6269</a>,
              June 2011.










<span class="grey">Petersson &amp; Nilsson          Standards Track                   [Page 15]</span>
</pre><!--NewPage--><pre class='newpage'><a name="page-16" id="page-16" href="#page-16" class="invisible"> </a>
<span class="grey"><a href="./rfc7239">RFC 7239</a>                Forwarded HTTP Extension               June 2014</span>


<span class="h2"><a class="selflink" name="appendix-A" href="#appendix-A">Appendix A</a>.  Acknowledgments</span>

   Thanks to Per Cederqvist, Alissa Cooper, Adrian Farrel, Stephen
   Farrell, Ned Freed, Per Hedbor, Amos Jeffries, Poul-Henning Kamp,
   Murray S. Kucherawy, Barry Leiba, Salvatore Loreto, Alexey Melnikov,
   S. Moonesamy, Susan Nichols, Mark Nottingham, Julian Reschke, John
   Sullivan, Willy Tarreau, and Dan Wing for their feedback.

Authors' Addresses

   Andreas Petersson
   Opera Software

   EMail: andreas@sbin.se


   Martin Nilsson
   Opera Software
   S:t Larsgatan 12
   Linkoping  SE-582 24

   EMail: nilsson@opera.com





























Petersson &amp; Nilsson          Standards Track                   [Page 16]

</pre><br />
<span class="noprint"><small><small>Html markup produced by rfcmarkup 1.111, available from
<a href="https://tools.ietf.org/tools/rfcmarkup/">https://tools.ietf.org/tools/rfcmarkup/</a>
</small></small></span>
</body></html>
